<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Juego de Coches Online</title>
<style>
body{margin:0;background:#222;color:white;font-family:Arial;overflow:hidden}
input{padding:8px;margin:5px;border-radius:5px;border:1px solid #555}
button{padding:10px 20px;border:none;border-radius:6px;cursor:pointer;background:#1e90ff;color:white}
#loginBox{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);background:#111;padding:25px;border-radius:15px;z-index:2000}
#game{display:none}
#menuOverlay{position:fixed;inset:0;background:rgba(0,0,0,.7);display:none;z-index:1500;justify-content:center;align-items:center}
#menuBox{background:#000;padding:20px;border-radius:15px;width:500px}
.menuButton{width:100%;margin:6px 0}
.section{display:none;margin-top:10px}
.friend{display:flex;align-items:center;gap:8px;margin:4px 0}
</style>
</head>

<body>

<!-- LOGIN -->
<div id="loginBox">
  <h2>Login / Registro</h2>
  <input id="emailInput" type="email" placeholder="Email"><br>
  <input id="passwordInput" type="password" placeholder="Contrase√±a"><br><br>
  <button id="registerBtn">Registrarse</button>
  <button id="loginBtn">Entrar</button>
</div>

<!-- JUEGO -->
<div id="game">
  <div id="menuOverlay">
    <div id="menuBox">
      <h3>Multijugador</h3>
      <button class="menuButton" id="openFriends">A√±adir amigos</button>

      <div id="friendsSection" class="section">
        <input id="friendEmail" placeholder="Email del amigo">
        <button id="addFriendBtn">A√±adir</button>
        <div id="friendsList"></div>
      </div>
    </div>
  </div>

  <p style="position:fixed;top:10px;left:10px">Pulsa ESC para men√∫</p>
</div>

<script type="module">
/* ---------------- FIREBASE ---------------- */
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged } 
from "https://www.gstatic.com/firebasejs/12.8.0/firebase-auth.js";
import { getFirestore, doc, setDoc, getDocs, collection, updateDoc } 
from "https://www.gstatic.com/firebasejs/12.8.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyBCutoJF6Rvw3A7ab3waAaMLDgklr5NEDA",
  authDomain: "juego-de-coches-d2613.firebaseapp.com",
  projectId: "juego-de-coches-d2613",
  storageBucket: "juego-de-coches-d2613.appspot.com",
  messagingSenderId: "34324442906",
  appId: "1:34324442906:web:640ef52af5b9a0442806a3"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

/* ---------------- LOGIN ---------------- */
registerBtn.onclick = async ()=>{
  await createUserWithEmailAndPassword(auth,emailInput.value,passwordInput.value);
};

loginBtn.onclick = async ()=>{
  await signInWithEmailAndPassword(auth,emailInput.value,passwordInput.value);
};

onAuthStateChanged(auth, async user=>{
  if(user){
    loginBox.style.display="none";
    game.style.display="block";

    await setDoc(doc(db,"users",user.uid),{
      email:user.email,
      online:true
    },{merge:true});
  }
});

window.addEventListener("beforeunload", async ()=>{
  if(auth.currentUser){
    await updateDoc(doc(db,"users",auth.currentUser.uid),{online:false});
  }
});

/* ---------------- MEN√ö ---------------- */
document.addEventListener("keydown",e=>{
  if(e.key==="Escape"){
    menuOverlay.style.display = menuOverlay.style.display==="flex"?"none":"flex";
  }
});

openFriends.onclick=()=>{
  friendsSection.style.display="block";
};

/* ---------------- AMIGOS ---------------- */
addFriendBtn.onclick = async ()=>{
  const email = friendEmail.value;
  if(!email) return;

  const snap = await getDocs(collection(db,"users"));
  let found=null;

  snap.forEach(d=>{
    if(d.data().email===email) found=d.data();
  });

  if(!found){
    alert("‚ùå Ese correo no est√° registrado");
    return;
  }

  const dot = found.online ? "üü¢" : "üî¥";
  friendsList.innerHTML += `<div class="friend">${dot} ${email}</div>`;
};
</script>
</body>
</html>

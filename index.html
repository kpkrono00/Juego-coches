<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Juego de Coches Tope Completo</title>
<style>
body { margin:0; font-family:Arial,sans-serif; background:#222; color:white; overflow:hidden; }
input { padding:8px; margin:5px 0; border-radius:5px; border:1px solid #555; width:200px; }
button { cursor:pointer; border:none; border-radius:5px; padding:8px 15px; }

#loginBox { background:#111; padding:30px; border-radius:15px; text-align:center; position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); z-index:2000; box-shadow:0 0 20px #000; }

#game { display:none; width:100vw; height:100vh; position:relative; }
#map { position:absolute; inset:0; background: repeating-linear-gradient(45deg,#2b2b2b 0px,#2b2b2b 40px,#3a3a3a 40px,#3a3a3a 80px); }
#car { position:absolute; width:26px; height:40px; background:red; border:2px solid black; top:50%; left:50%; transform-origin:50% 50%; margin-left:-13px; margin-top:-20px; }

#menuOverlay { position:absolute; inset:0; background:rgba(0,0,0,0.7); display:none; z-index:1500; justify-content:center; align-items:center; pointer-events:none; flex-direction:column; }
#menuBox { width:600px; background:rgba(0,0,0,0.95); padding:25px; border-radius:20px; display:flex; flex-direction:column; align-items:center; pointer-events:auto; }

.menuButton { padding:12px 25px; margin:10px; font-size:20px; border-radius:8px; border:1px solid #444; cursor:pointer; background:#1e90ff; color:white; width:80%; }
.section { display:none; margin-top:15px; width:100%; max-height:250px; overflow-y:auto; }

#modeDisplay { position:fixed; left:10px; top:10px; font-size:22px; z-index:950; }
</style>
</head>
<body>

<div id="loginBox">
  <h2>Registro / Login</h2>
  <input id="emailInput" type="email" placeholder="Email"><br>
  <input id="passwordInput" type="password" placeholder="Contraseña"><br><br>
  <button id="registerBtn">Registrarse</button>
  <button id="loginBtn">Entrar</button>
</div>

<div id="game">
  <div id="map"></div>
  <div id="car"></div>
  <div id="modeDisplay">Modo: Normal</div>

  <div id="menuOverlay">
    <div id="menuBox">
      <h2>Opciones del Juego</h2>
      <button class="menuButton" data-section="multiplayerSection">Multijugador</button>

      <div id="multiplayerSection" class="section">
        <h3>Multijugador</h3>

        <button class="menuButton" data-submenu="friendsSubmenu">Añadir Amigos</button>

        <div id="friendsSubmenu" class="section">
          <input type="text" id="friendName" placeholder="Correo del amigo">
          <button id="addFriendBtn" class="menuButton">Añadir</button>
          <div id="friendsList"></div>
        </div>

      </div>
    </div>
  </div>
</div>

<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";

import {
getAuth,
createUserWithEmailAndPassword,
signInWithEmailAndPassword,
onAuthStateChanged
} from "https://www.gstatic.com/firebasejs/12.8.0/firebase-auth.js";

import {
getFirestore,
doc,
setDoc,
getDoc,
updateDoc,
arrayUnion,
collection,
query,
where,
getDocs
} from "https://www.gstatic.com/firebasejs/12.8.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyBCutoJF6Rvw3A7ab3waAaMLDgklr5NEDA",
  authDomain: "juego-de-coches-d2613.firebaseapp.com",
  projectId: "juego-de-coches-d2613",
  storageBucket: "juego-de-coches-d2613.appspot.com",
  messagingSenderId: "34324442906",
  appId: "1:34324442906:web:640ef52af5b9a0442806a3"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

const emailInput = document.getElementById("emailInput");
const passwordInput = document.getElementById("passwordInput");

document.getElementById("registerBtn").addEventListener("click", async ()=>{
 try{
   const cred = await createUserWithEmailAndPassword(auth,emailInput.value,passwordInput.value);

   await setDoc(doc(db,"users",cred.user.uid),{
     email: emailInput.value,
     friends: [],
     requests:[]
   });

   alert("Registrado correctamente");
 }catch(e){
   alert(e.message);
 }
});

document.getElementById("loginBtn").addEventListener("click", async ()=>{
 try{
   await signInWithEmailAndPassword(auth,emailInput.value,passwordInput.value);
 }catch(e){
   alert(e.message);
 }
});

let currentUser;

onAuthStateChanged(auth, async user=>{
 if(!user) return;

 currentUser = user;

 document.getElementById("loginBox").style.display="none";
 document.getElementById("game").style.display="block";

 const ref = doc(db,"users",user.uid);
 const snap = await getDoc(ref);
 const data = snap.data();

 // Mostrar solicitudes
 if(data.requests.length > 0){

   for(const requesterUID of data.requests){

     const requesterSnap = await getDoc(doc(db,"users",requesterUID));
     const requesterEmail = requesterSnap.data().email;

     const aceptar = confirm(`${requesterEmail} te ha enviado solicitud ¿Aceptar?`);

     if(aceptar){

       await updateDoc(ref,{
         friends: arrayUnion(requesterUID),
         requests:[]
       });

       await updateDoc(doc(db,"users",requesterUID),{
         friends: arrayUnion(user.uid)
       });

       alert("Solicitud aceptada ✅");

     }else{

       await updateDoc(ref,{
         requests:[]
       });

       alert("Solicitud rechazada ❌");
     }
   }
 }

 mostrarAmigos();
});

async function mostrarAmigos(){

 const ref = doc(db,"users",currentUser.uid);
 const snap = await getDoc(ref);
 const data = snap.data();

 let lista="";

 for(const uid of data.friends){
   const friendSnap = await getDoc(doc(db,"users",uid));
   lista += friendSnap.data().email + "<br>";
 }

 document.getElementById("friendsList").innerHTML = lista || "Sin amigos todavía";
}

document.getElementById('addFriendBtn').addEventListener("click", async ()=>{

 const email = document.getElementById('friendName').value;

 if(!email) return;

 const q = query(collection(db,"users"), where("email","==",email));
 const result = await getDocs(q);

 if(result.empty){
   alert("Ese correo no está registrado ❌");
   return;
 }

 const friendDoc = result.docs[0];

 await updateDoc(doc(db,"users",friendDoc.id),{
   requests: arrayUnion(currentUser.uid)
 });

 alert("Solicitud enviada ✅");
});


// MENU
const menuOverlay = document.getElementById("menuOverlay");
let paused=false;

document.addEventListener("keydown", e=>{
 if(e.key==="Escape"){
   paused=!paused;
   menuOverlay.style.display=paused?'flex':'none';
 }
});

document.querySelectorAll('[data-section]').forEach(btn=>{
 btn.addEventListener("click", ()=>{
   document.querySelectorAll('.section').forEach(s=>s.style.display='none');
   document.getElementById(btn.dataset.section).style.display='block';
 });
});

document.querySelectorAll('[data-submenu]').forEach(btn=>{
 btn.addEventListener("click", ()=>{
   document.querySelectorAll('#multiplayerSection .section').forEach(s=>s.style.display='none');
   document.getElementById(btn.dataset.submenu).style.display='block';
 });
});

</script>
</body>
</html>

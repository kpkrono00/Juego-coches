<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Juego de Coches</title>
<style>
body { margin:0; font-family:Arial,sans-serif; background:#222; color:white; overflow:hidden; }

/* LOGIN */
#loginBox { background:#111; padding:20px; border-radius:10px; text-align:center; position:relative; z-index:2000; }

/* JUEGO */
#game { display:none; width:100vw; height:100vh; position:relative; }
#map { position:absolute; inset:0; background: repeating-linear-gradient(45deg,#2b2b2b 0px,#2b2b2b 40px,#3a3a3a 40px,#3a3a3a 80px); }
#car { position:absolute; width:26px; height:40px; background:red; border:2px solid black; top:50%; left:50%; transform-origin:center; margin-left:-13px; margin-top:-20px; }

/* MENÚ */
#menuOverlay { position:absolute; inset:0; background:rgba(0,0,0,0.7); display:none; z-index:1500; justify-content:center; align-items:center; pointer-events:none; }
#menuBox { width:500px; background:rgba(0,0,0,0.9); padding:20px; border-radius:12px; display:flex; flex-direction:column; align-items:center; pointer-events:auto; }
.menuButton { padding:12px 25px; margin:10px; font-size:20px; border-radius:8px; border:1px solid #444; cursor:pointer; background:#1e90ff; color:white; width:70%; text-align:center; }
.section { display:none; margin-top:15px; width:100%; max-height:200px; overflow-y:auto; pointer-events:auto; }
.option { padding:10px; border:1px solid #444; margin-bottom:8px; cursor:pointer; }
.option.selected { background:#1e90ff; }

#turboUI { position:fixed; right:30px; top:50%; width:100px; height:100px; z-index:900; pointer-events:none; }
#turboRing { width:100%; height:100%; border-radius:50%; background:conic-gradient(dodgerblue 360deg,#111 360deg); }
#turboCenter { position:absolute; width:65px; height:65px; background:black; border-radius:50%; top:17.5px; left:17.5px; display:flex; align-items:center; justify-content:center; font-size:26px; pointer-events:none; }
#modeDisplay { position:fixed; left:10px; top:10px; color:white; font-size:20px; z-index:950; }
</style>
</head>
<body>

<!-- LOGIN -->
<div id="loginBox">
  <h2>Registro / Login</h2>
  <input id="emailInput" placeholder="Email">
  <input id="passwordInput" type="password" placeholder="Password">
  <br>
  <button id="registerBtn">Registrarse</button>
  <button id="loginBtn">Entrar</button>
</div>

<!-- JUEGO -->
<div id="game">
  <div id="map"></div>
  <div id="car"></div>
  <div id="modeDisplay">Modo: Normal</div>

  <!-- MENÚ -->
  <div id="menuOverlay">
    <div id="menuBox">
      <h2>Opciones</h2>
      <button class="menuButton" data-section="cochesSection">Coches</button>
      <button class="menuButton" data-section="driveSection">Tipo de conducción</button>
      <button class="menuButton" data-section="worldsSection">Mundos</button>
      <button class="menuButton" data-section="multiplayerSection">Multijugador</button>

      <div id="cochesSection" class="section"></div>
      <div id="driveSection" class="section">
        <div class="option" data-drive="normal">Normal</div>
        <div class="option" data-drive="race">Carrera</div>
        <div class="option" data-drive="drift">Drift</div>
      </div>
      <div id="worldsSection" class="section">
        <div class="option" data-world="normal">Mundo Normal</div>
        <div class="option" data-world="race">Carrera</div>
      </div>
      <div id="multiplayerSection" class="section">
        <h3>Multijugador</h3>
        <button class="menuButton" data-submenu="friendsSubmenu">Añadir Amigos</button>
        <button class="menuButton" data-submenu="roomSubmenu">Sala</button>
        <button class="menuButton" data-submenu="registerSubmenu">Registrarse</button>

        <div id="friendsSubmenu" class="section">
          <input type="text" id="friendName" placeholder="Nombre del amigo" style="width:90%; padding:8px; margin-bottom:5px;">
          <button id="addFriendBtn" class="menuButton">Añadir</button>
          <div id="friendsList"></div>
        </div>
        <div id="roomSubmenu" class="section">
          <input type="text" id="roomCode" placeholder="Código de sala" style="width:90%; padding:8px; margin-bottom:5px;">
          <button id="createRoomBtn" class="menuButton">Crear Sala</button>
          <input type="text" id="joinCode" placeholder="Código para unirse" style="width:90%; padding:8px; margin-bottom:5px;">
          <button id="joinRoomBtn" class="menuButton">Unirse</button>
          <div id="roomList"></div>
        </div>
        <div id="registerSubmenu" class="section">
          <input type="text" id="username" placeholder="Nombre" style="width:90%; padding:8px; margin-bottom:5px;">
          <input type="password" id="passwordReg" placeholder="Contraseña" style="width:90%; padding:8px; margin-bottom:5px;">
          <button id="registerUserBtn" class="menuButton">Registrar</button>
          <div id="registerStatus"></div>
        </div>
      </div>
    </div>
  </div>

  <div id="turboUI">
    <div id="turboRing"></div>
    <div id="turboCenter">⚡</div>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-auth.js";

// ---------- FIREBASE ----------
const firebaseConfig = {
  apiKey: "AIzaSyBCutoJF6Rvw3A7ab3waAaMLDgklr5NEDA",
  authDomain: "juego-de-coches-d2613.firebaseapp.com",
  projectId: "juego-de-coches-d2613",
  storageBucket: "juego-de-coches-d2613.firebasestorage.app",
  messagingSenderId: "34324442906",
  appId: "1:34324442906:web:640ef52af5b9a0442806a3"
};
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const emailInput = document.getElementById("emailInput");
const passwordInput = document.getElementById("passwordInput");

// ---------- LOGIN ----------
document.getElementById("registerBtn").addEventListener("click", async ()=>{
  try{ await createUserWithEmailAndPassword(auth,emailInput.value,passwordInput.value); alert("Registrado correctamente"); } catch(e){ alert(e.message); }
});
document.getElementById("loginBtn").addEventListener("click", async ()=>{
  try{ await signInWithEmailAndPassword(auth,emailInput.value,passwordInput.value); alert("Login correcto"); } catch(e){ alert(e.message); }
});
onAuthStateChanged(auth,user=>{ if(user){ document.getElementById("loginBox").style.display="none"; document.getElementById("game").style.display="block"; } });

// ---------- JUEGO ----------
const car = document.getElementById("car");
const turboRing = document.getElementById("turboRing");
const menuOverlay = document.getElementById("menuOverlay");
const modeDisplay = document.getElementById("modeDisplay");

let x=window.innerWidth/2, y=window.innerHeight/2, angle=0, speed=0, turbo=100;
let keys={}, driveType="normal", paused=false, currentWorld="normal";

const carList = [
  {name:'Nissan GTR', width:26, height:48, color:'red'},
  {name:'BMW M3', width:26, height:48, color:'blue'},
  {name:'BMW i8', width:26, height:48, color:'cyan'},
  {name:'BMW X5', width:28, height:50, color:'green'},
  {name:'Bus', width:40, height:70, color:'yellow'}
];
const cochesSection = document.getElementById('cochesSection');
carList.forEach(c=>{
  const div=document.createElement('div'); div.classList.add('option'); div.textContent=c.name; div.style.background=c.color;
  div.addEventListener("click",()=>{ document.querySelectorAll('#cochesSection .option').forEach(o=>o.classList.remove('selected')); div.classList.add('selected'); car.style.width=c.width+'px'; car.style.height=c.height+'px'; car.style.background=c.color; });
  cochesSection.appendChild(div);
});

// ---------- INPUT ----------
document.addEventListener("keydown", e=>{ 
  if(["w","a","s","d"," "].includes(e.key)) e.preventDefault(); 
  if(e.key==="Escape") toggleMenu(); 
  if(!paused && driveType==="drift" && e.key==="e") angle+=20; 
  keys[e.key]=true; 
});
document.addEventListener("keyup", e=> keys[e.key]=false);
window.addEventListener("blur", ()=>{ for(let k in keys) keys[k]=false; });

// ---------- MENÚ ----------
function toggleMenu(){ paused = !paused; menuOverlay.style.display = paused?'flex':'none'; }
document.querySelectorAll('#menuBox .menuButton[data-section]').forEach(btn=>{
  btn.addEventListener("click", ()=>{
    const id=btn.getAttribute('data-section');
    document.querySelectorAll('.section').forEach(s=>s.style.display='none');
    document.getElementById(id).style.display='block';
  });
});
document.querySelectorAll('#menuBox .option[data-drive]').forEach(opt=>{
  opt.addEventListener("click", ()=>{ driveType=opt.getAttribute('data-drive'); modeDisplay.textContent="Modo: "+(driveType==="normal"?"Normal":driveType==="race"?"Carrera":"Drift"); });
});
document.querySelectorAll('#menuBox .option[data-world]').forEach(opt=>{
  opt.addEventListener("click", ()=>{ currentWorld=opt.getAttribute('data-world'); paused=false; menuOverlay.style.display='none'; });
});
document.querySelectorAll('#menuBox .menuButton[data-submenu]').forEach(btn=>{
  btn.addEventListener("click", ()=>{ const id=btn.getAttribute('data-submenu'); document.querySelectorAll('#multiplayerSection .section').forEach(s=>s.style.display='none'); document.getElementById(id).style.display='block'; });
});

// ---------- MULTIJUGADOR SIMULADO ----------
const friends=[]; document.getElementById('addFriendBtn').addEventListener("click", ()=>{
  const name=document.getElementById('friendName').value; if(name){ friends.push(name); document.getElementById('friendsList').textContent=friends.join(', '); }
});
let roomCodes=[]; 
document.getElementById('createRoomBtn').addEventListener("click", ()=>{
  const code=document.getElementById('roomCode').value; if(code){ roomCodes.push(code); document.getElementById('roomList').textContent='Sala creada: '+code; }
});
document.getElementById('joinRoomBtn').addEventListener("click", ()=>{
  const code=document.getElementById('joinCode').value; if(roomCodes.includes(code)){ alert('Te has unido a la sala: '+code); } else alert('Código incorrecto');
});
document.getElementById('registerUserBtn').addEventListener("click", ()=>{
  const user=document.getElementById('username').value; const pass=document.getElementById('passwordReg').value;
  if(user && pass){ localStorage.setItem('username',user); localStorage.setItem('password',pass); document.getElementById('registerStatus').textContent='Registrado!'; }
});

// ---------- LOOP JUEGO ----------
function update(){
  if(!paused){
    let turboBoost = (driveType==='race')?1.5:1;
    let speedFactor = (driveType==='race')?1.3:1;
    if(keys['a']) angle -= 4*speedFactor;
    if(keys['d']) angle += 4*speedFactor;
    if(keys['w']) speed += 0.3*speedFactor;
    if(keys['s']) speed -= 0.3*speedFactor;

    x = Math.max(20,Math.min(window.innerWidth-20, x + Math.sin(angle*Math.PI/180)*speed));
    y = Math.max(20,Math.min(window.innerHeight-20, y - Math.cos(angle*Math.PI/180)*speed));

    car.style.left = x+'px';
    car.style.top = y+'px';
    car.style.transform = `rotate(${angle}deg)`;

    if(keys[' '] && turbo>0){ speed += 0.7*turboBoost; turbo-=1.2; }
    else if(turbo<100) turbo+=0.5;

    speed *= 0.95;
    turbo = Math.max(0,Math.min(100,turbo));
    turboRing.style.background = `conic-gradient(dodgerblue ${turbo*3.6}deg, #111 ${turbo*3.6}deg)`;
  }
  requestAnimationFrame(update);
}
update();
</script>
</body>
</html>
